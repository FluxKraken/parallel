name: Sync GNU Parallel Releases

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"   # nightly at 03:00 UTC

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Sync tags to GitHub Releases
        run: |
          set -euo pipefail

          echo "Fetching all tags"
          git fetch --tags --force

          echo "Getting existing GitHub releases"
          existing_releases=$(gh release list --limit 1000 --json tagName -q '.[].tagName')

          echo "Processing GNU release tags"

          # Only match 8-digit date tags (YYYYMMDD)
          git tag | grep -E '^(19|20)[0-9]{6}$' | while read tag; do
            echo "Checking tag: $tag"

            if echo "$existing_releases" | grep -qx "$tag"; then
              echo "Release already exists for $tag"
              continue
            fi

            tarball="parallel-${tag}.tar.bz2"
            url="https://ftp.gnu.org/gnu/parallel/${tarball}"

            echo "Downloading $url"
            curl -fLO "$url"

            echo "Creating GitHub release for $tag"
            gh release create "$tag" \
              --title "$tag" \
              --notes "Mirror of official GNU Parallel release $tag" \
              "$tarball"

            rm -f "$tarball"
          done

          echo "Sync complete"
