name: Sync GNU Parallel Releases

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Sync official GNU releases
        run: |
          set -euo pipefail

          echo "Fetching GNU release list"

          curl -s https://ftp.gnu.org/gnu/parallel/ \
            | grep -oE 'parallel-[0-9]{8}\.tar\.bz2' \
            | sort -u > versions.txt

          echo "Getting existing GitHub releases"

          existing_releases=$(gh release list --limit 1000 --json tagName -q '.[].tagName')

          while read tarball; do
            version=$(echo "$tarball" | grep -oE '[0-9]{8}')

            echo "Checking version: $version"

            if echo "$existing_releases" | grep -qx "$version"; then
              echo "Release exists, skipping"
              continue
            fi

            url="https://ftp.gnu.org/gnu/parallel/${tarball}"

            echo "Downloading $url"
            curl -fLO "$url"

            echo "Creating GitHub release $version"

            gh release create "$version" \
              --title "$version" \
              --notes "Mirror of official GNU Parallel release $version" \
              "$tarball"

            rm -f "$tarball"

          done < versions.txt

          rm -f versions.txt

          echo "Sync complete"
