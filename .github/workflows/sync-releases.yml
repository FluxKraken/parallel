name: Sync GNU Parallel Releases

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"   # nightly

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Authenticate gh
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Sync tags to GitHub Releases
        run: |
          set -euo pipefail

          existing_releases=$(gh release list --limit 1000 --json tagName -q '.[].tagName')

          for tag in $(git tag); do
            echo "Checking tag: $tag"

            if echo "$existing_releases" | grep -qx "$tag"; then
              echo "Release already exists for $tag"
              continue
            fi

            version="$tag"
            tarball="parallel-${version}.tar.bz2"
            url="https://ftp.gnu.org/gnu/parallel/${tarball}"

            echo "Fetching ${url}"

            curl -fLO "${url}"

            gh release create "${tag}" \
              --title "${tag}" \
              --notes "Mirror of official GNU Parallel release ${version}" \
              "${tarball}"

            rm -f "${tarball}"
          done
